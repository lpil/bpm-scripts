#!/usr/bin/env ruby

filetypes   = ['.flac', '.ogg', '.mp3']
num_threads = 4

#
# bpm_tagdir
#
# Run's Mark Hill's bpm-tag script on all mp3, flac, and ogg media files in
# the CWD (and sub directories).
#
# Skips files with the BPM in the file name, like this:
#   Remarc - Suicidal (165 BPM).flac
#

require 'shellwords'

def calculate_bpm(file, bot_bpm = 135, top_bpm = 250, force = false)
  `bpm-tag -m #{bot_bpm} -x #{top_bpm} #{'-f' if force} #{file.shellescape}`
end

Thread.abort_on_exception = true

files = Dir.glob('**/*').select do |f|
  # Filter out directories
  (!File.directory? f) &&

  # Filter out files with incorrect extensions (i.e. not mp3, etc)
  (filetypes.any? { |extension| f.ends_with? extension }) &&

  # Filter out files that have the BPM in the name
  (!f.match(/.+\(\d{2,4}.?\d{0,4} BPM\).\w+\z/))
end

puts "#{files.size} tracks to process"

# Process files in parallel
files.each.with_index do |file|
  sleep 1 until Thread.list.size < num_threads + 1
  Thread.new do
    calculate_bpm file
  end
end

# Wait until we're done
sleep 1 until Thread.list.size == 1

puts '...done!'
